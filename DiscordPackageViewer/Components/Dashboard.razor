@inject PackageLoaderService Loader

@if (Loader.Data is { } data)
{
    <div class="content-header">ðŸ“Š Dashboard</div>
    <div class="content-body">
        <StatCardGrid Items="@GetStats(data)" />

        <!-- User Profile Summary -->
        @if (data.UserProfile is { } profile)
        {
            <h3 class="section-title">Account Summary</h3>
            <div class="card" style="display: flex; align-items: center; gap: 16px;">
                @if (data.AvatarBytes is not null)
                {
                    <img src="data:@data.AvatarMimeType;base64,@Convert.ToBase64String(data.AvatarBytes)"
                         class="avatar avatar-lg" alt="Avatar" />
                }
                <div>
                    <div style="font-size: 1.25rem; font-weight: 700;">@(profile.GlobalName ?? profile.Username)</div>
                    <div class="text-muted">@profile.Username@(profile.Discriminator > 0 ? $"#{profile.Discriminator}" : "")</div>
                    <div class="text-muted" style="margin-top: 4px;">ID: @profile.Id</div>
                    <div style="margin-top: 8px; display: flex; gap: 4px; flex-wrap: wrap;">
                        @if (profile.Verified)
                        {
                            <span class="chip chip-positive">âœ“ Verified</span>
                        }
                        @if (profile.HasMobile)
                        {
                            <span class="chip">ðŸ“± Mobile</span>
                        }
                        @foreach (var flag in profile.Flags.Take(5))
                        {
                            <span class="chip">@flag.Replace("_", " ").ToLowerInvariant()</span>
                        }
                    </div>
                </div>
            </div>
        }

        <TopChannelsChart Channels="data.Channels" />
        <MessagesTimeline Channels="data.Channels" />

        @if (data.Servers.Any())
        {
            <ServerGrid Servers="data.Servers.Values.ToList()" Title="Servers" />
        }
    </div>
}

@code {
    private static StatCardGrid.StatItem[] GetStats(PackageData data) =>
    [
        new("Total Messages", data.TotalMessages.ToString("N0"), $"across {data.TotalChannels} channels"),
        new("Servers", data.TotalServers.ToString()),
        new("Friends", data.TotalFriends.ToString()),
        new("DM Channels", data.Channels.Values.Count(c => c.IsDm).ToString()),
        new("Connections", (data.UserProfile?.Connections?.Count ?? 0).ToString()),
        new("Support Tickets", data.SupportTickets.Count.ToString()),
    ];
}
