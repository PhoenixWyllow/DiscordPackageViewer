@* Server detail view — roles, channels, emoji, audit log. Own render boundary. *@

<div style="margin-bottom: 16px;">
    <span style="cursor: pointer; color: var(--text-link); font-size: 0.875rem;" @onclick="() => OnBack.InvokeAsync()">
        ← Back to server list
    </span>
</div>

<div class="card" style="display: flex; align-items: center; gap: 16px;">
    <div class="server-icon" style="width: 64px; height: 64px; font-size: 1.5rem;">
        @if (Server.IconDataUrl is not null)
        {
            <img src="@Server.IconDataUrl" alt="@Server.DisplayName" />
        }
        else
        {
            @Server.DisplayName[..Math.Min(2, Server.DisplayName.Length)].ToUpper()
        }
    </div>
    <div>
        <div style="font-size: 1.25rem; font-weight: 700;">@Server.DisplayName</div>
        <div class="text-muted">ID: @Server.ServerId</div>
        @if (Server.Guild?.Description is not null)
        {
            <div style="margin-top: 4px; color: var(--text-secondary);">@Server.Guild.Description</div>
        }
    </div>
</div>

@* Roles *@
@if (Server.Guild?.Roles?.Any() == true)
{
    <h3 class="section-title">Roles (@Server.Guild.Roles.Count)</h3>
    <div class="card" style="display: flex; flex-wrap: wrap; gap: 4px;">
        @foreach (var role in Server.Guild.Roles.Values.OrderBy(r => r.Position))
        {
            var colorHex = role.Color > 0 ? $"#{role.Color:X6}" : "var(--text-secondary)";
            <span class="chip" style="border: 1px solid @colorHex; color: @colorHex;">
                @role.Name
            </span>
        }
    </div>
}

@* Channels *@
@if (Server.Channels.Any())
{
    <h3 class="section-title">Channels (@Server.Channels.Count)</h3>
    <div class="card">
        <table class="data-table">
            <thead>
                <tr><th>Name</th><th>Type</th><th>Position</th></tr>
            </thead>
            <tbody>
                @foreach (var ch in Server.Channels.OrderBy(c => c.Position ?? 0))
                {
                    <tr>
                        <td># @ch.Name</td>
                        <td class="text-muted">@(ch.Type switch { 0 => "Text", 2 => "Voice", 4 => "Category", 5 => "Announcement", 13 => "Stage", 15 => "Forum", _ => $"Type {ch.Type}" })</td>
                        <td class="text-muted">@ch.Position</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@* Emoji *@
@if (Server.Emojis.Any())
{
    <h3 class="section-title">Emoji (@Server.Emojis.Count)</h3>
    <div class="card" style="display: flex; flex-wrap: wrap; gap: 8px;">
        @foreach (var emoji in Server.Emojis)
        {
            if (Server.EmojiDataUrls.TryGetValue(emoji.Id, out var dataUrl))
            {
                <div title=":@emoji.Name:" style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                    <img src="@dataUrl" alt="@emoji.Name" style="width: 32px; height: 32px;" />
                    <span style="font-size: 0.6875rem; color: var(--text-muted);">@emoji.Name</span>
                </div>
            }
            else
            {
                <span class="chip" title="@emoji.Id">:@emoji.Name:</span>
            }
        }
    </div>
}

@* Audit Log *@
@if (Server.AuditLog.Any())
{
    <h3 class="section-title">Audit Log (@Server.AuditLog.Count entries)</h3>
    <div class="card">
        <table class="data-table">
            <thead>
                <tr><th>Action</th><th>User</th><th>Target</th><th>Reason</th></tr>
            </thead>
            <tbody>
                @foreach (var entry in Server.AuditLog.Take(100))
                {
                    <tr>
                        <td>@entry.ActionType</td>
                        <td class="text-muted">@(entry.UserId ?? "—")</td>
                        <td class="text-muted">@(entry.TargetId ?? "—")</td>
                        <td>@(entry.Reason ?? "—")</td>
                    </tr>
                }
            </tbody>
        </table>
        @if (Server.AuditLog.Count > 100)
        {
            <p class="text-muted mt-1">Showing first 100 of @Server.AuditLog.Count entries.</p>
        }
    </div>
}

@code {
    [Parameter, EditorRequired] public LoadedServer Server { get; set; } = default!;
    [Parameter] public EventCallback OnBack { get; set; }
}
