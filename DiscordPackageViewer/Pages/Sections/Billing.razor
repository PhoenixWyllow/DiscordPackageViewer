@page "/billing"
@inject PackageLoaderService Loader

<PageTitle>Billing â€” Discord Package Viewer</PageTitle>

<div class="content-header">ðŸ’³ Billing & Data Exports</div>
<div class="content-body">
    @if (Loader.Data is not { } data || !data.DataExports.Any())
    {
        <p class="text-muted">No billing or export data found in the package.</p>
        return;
    }

    <div class="stat-cards">
        @foreach (var export in data.DataExports)
        {
            <div class="stat-card">
                <span class="stat-label">@export.Section</span>
                <span class="stat-value">@export.RecordCount</span>
                <span class="stat-sub">records</span>
            </div>
        }
    </div>

    @foreach (var export in data.DataExports.OrderBy(e => e.Section))
    {
        <h3 class="section-title">@export.Section</h3>
        @if (export.Metadata?.Description is not null)
        {
            <p class="section-subtitle">@export.Metadata.Description</p>
        }

        <div class="card" style="overflow-x: auto;">
            @if (export.Metadata?.Columns.Any() == true && export.Records.Any())
            {
                <table class="data-table">
                    <thead>
                        <tr>
                            @foreach (var col in export.Metadata.Columns)
                            {
                                <th title="@col.Description">@col.Name</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var record in export.Records.Take(100))
                        {
                            <tr>
                                @foreach (var col in export.Metadata.Columns)
                                {
                                    // Try to find the property by column name (snake_case)
                                    var propName = col.Name.Replace(" ", "_").ToLowerInvariant();
                                    string cellValue = "â€”";
                                    if (record.ValueKind == System.Text.Json.JsonValueKind.Object)
                                    {
                                        foreach (var prop in record.EnumerateObject())
                                        {
                                            if (prop.Name.Equals(propName, StringComparison.OrdinalIgnoreCase) ||
                                                prop.Name.Replace("_", " ").Equals(col.Name, StringComparison.OrdinalIgnoreCase))
                                            {
                                                cellValue = prop.Value.ValueKind switch
                                                {
                                                    System.Text.Json.JsonValueKind.String => prop.Value.GetString() ?? "â€”",
                                                    System.Text.Json.JsonValueKind.Number => prop.Value.GetRawText(),
                                                    System.Text.Json.JsonValueKind.True => "Yes",
                                                    System.Text.Json.JsonValueKind.False => "No",
                                                    System.Text.Json.JsonValueKind.Null => "â€”",
                                                    _ => prop.Value.GetRawText().Length > 100 
                                                        ? prop.Value.GetRawText()[..100] + "..." 
                                                        : prop.Value.GetRawText()
                                                };
                                                break;
                                            }
                                        }
                                    }
                                    <td>@cellValue</td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
                @if (export.Records.Count > 100)
                {
                    <p class="text-muted mt-1">Showing first 100 of @export.Records.Count records.</p>
                }
            }
            else
            {
                <p class="text-muted">No records in this section.</p>
            }
        </div>
    }

    <p class="text-muted" style="margin-top: 24px; font-size: 0.8125rem;">
        Generated at: @(data.DataExports.FirstOrDefault()?.GeneratedAt ?? "Unknown")
    </p>
</div>
