@inherits LayoutComponentBase
@implements IDisposable
@inject PackageLoaderService Loader
@inject NavigationManager Nav

<ToastContainer />

@if (isNavigating)
{
    <div class="page-loading-overlay">
        <div class="reading-spinner"></div>
    </div>
}

@if (!Loader.IsLoaded && !Loader.IsLoading)
{
    <!-- Full-screen layout for pre-load pages (home, privacy) -->
    <div class="app-container">
        <div class="main-content">
            <ErrorBoundary @ref="_errorBoundary">
                <ChildContent>@Body</ChildContent>
                <ErrorContent Context="exception">
                    <ErrorReport Exception="exception" OnRecover="Recover" />
                </ErrorContent>
            </ErrorBoundary>
        </div>
    </div>
}
else if (Loader.IsLoading)
{
    <div class="app-container">
        <div class="main-content">
            <div class="upload-zone">
                <div class="upload-icon">📦</div>
                <h2>@Loader.ProgressMessage</h2>
                <div class="progress-bar-container" style="width: 300px; margin-top: 8px;">
                    <div class="progress-bar-fill" style="width: @((Loader.Progress * 100).ToString("F0"))%"></div>
                </div>
                <p class="text-muted">@((Loader.Progress * 100).ToString("F0"))%</p>
            </div>
        </div>
    </div>
}
else
{
    <!-- Main app layout with sidebar -->
    <div class="app-container">
        <NavMenu />
        <div class="main-content">
            <ErrorBoundary @ref="_errorBoundary">
                <ChildContent>@Body</ChildContent>
                <ErrorContent Context="exception">
                    <ErrorReport Exception="exception" OnRecover="Recover" />
                </ErrorContent>
            </ErrorBoundary>
        </div>
    </div>
}

@code {
    private bool isNavigating;
    private IDisposable? locationChangingReg;
    private ErrorBoundary? _errorBoundary;

    protected override void OnInitialized()
    {
        Loader.OnStateChanged += StateHasChanged;
        Nav.LocationChanged += OnLocationChanged;
        locationChangingReg = Nav.RegisterLocationChangingHandler(OnLocationChanging);
    }

    private ValueTask OnLocationChanging(LocationChangingContext ctx)
    {
        // Only show overlay when a data package is loaded (pages are heavy)
        if (Loader.IsLoaded)
        {
            isNavigating = true;
            StateHasChanged();
        }
        return ValueTask.CompletedTask;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        // Reset error boundary on navigation so the user isn't stuck
        _errorBoundary?.Recover();

        if (isNavigating)
        {
            isNavigating = false;
            InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        Loader.OnStateChanged -= StateHasChanged;
        Nav.LocationChanged -= OnLocationChanged;
        locationChangingReg?.Dispose();
    }

    private void Recover() => _errorBoundary?.Recover();
}
